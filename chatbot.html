<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AcademiaBot - AI Academic Assistant</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#135bec",
              "background-light": "#f6f6f8",
              "background-dark": "#101622",
              "ai-primary": "#10B981",
              "ai-secondary": "#3B82F6",
              "ai-accent": "#8B5CF6"
            },
            fontFamily: {
              "display": ["Lexend", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
    <style>
        .typing-indicator {
            display: inline-block;
            position: relative;
        }
        
        .typing-indicator span {
            display: inline-block;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.1s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.2s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .message-fade-in {
            animation: messageFadeIn 0.3s ease-out;
        }
        
        @keyframes messageFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-container {
            scroll-behavior: smooth;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .dark .chat-container::-webkit-scrollbar-track {
            background: #374151;
        }
        
        .dark .chat-container::-webkit-scrollbar-thumb {
            background: #6B7280;
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <!-- TopNavBar -->
        <header class="sticky top-0 z-10 w-full bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-800">
            <div class="container mx-auto">
                <div class="flex items-center justify-between whitespace-nowrap px-4 sm:px-6 lg:px-8 py-3">
                    <div class="flex items-center gap-4 text-gray-900 dark:text-white">
                        <div class="size-6 text-primary">
                            <svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip0_6_330)">
                                    <path clip-rule="evenodd" d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z" fill="currentColor" fill-rule="evenodd"></path>
                                </g>
                                <defs>
                                    <clipPath id="clip0_6_330"><rect fill="white" height="48" width="48"></rect></clipPath>
                                </defs>
                            </svg>
                        </div>
                        <h2 class="text-lg font-bold tracking-[-0.015em] text-gray-900 dark:text-white">AcademiaTrack</h2>
                    </div>
                    <div class="flex flex-1 justify-end items-center gap-6">
                        <nav class="hidden md:flex items-center gap-8">
                            <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="homepage.html">Dashboard</a>
                            <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="progresspage.html">Progress</a>
                            <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="activities-page.html">Activities</a>
                            <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="profile-page.html">Profile</a>
                            <a class="text-sm font-bold text-ai-primary dark:text-ai-primary" href="#">AcademiaBot</a>
                        </nav>
                    </div>
                    <button id="menu-toggle" class="md:hidden p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800">
                        <span class="material-symbols-outlined text-gray-800 dark:text-gray-200">menu</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg z-50 md:hidden transform -translate-x-full transition-transform duration-300">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <div class="size-6 text-primary">
                        <svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <g clip-path="url(#clip0_6_330)">
                                <path clip-rule="evenodd" d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z" fill="currentColor" fill-rule="evenodd"></path>
                            </g>
                        </svg>
                    </div>
                    <h2 class="text-lg font-bold">AcademiaTrack</h2>
                </div>
            </div>
            <nav class="p-4">
                <ul class="space-y-4">
                    <li>
                        <a href="homepage.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Dashboard</a>
                    </li>
                    <li>
                        <a href="progresspage.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Progress</a>
                    </li>
                 
                    <li>
                        <a href="activitiespage.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Activities</a>
                    </li>
                    <li>
                        <a href="profile-page.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Profile</a>
                    </li>
                               <li>
                                    <a href="#" class="block text-primary font-medium py-2">ChatBot</a>
                                </li>
                            <li class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <button id="mobile-logout" class="block w-full text-center bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                                        Logout
                                    </button>
                                </li>
                </ul>
            </nav>
        </div>

        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="max-w-4xl mx-auto">
                <!-- Header Section -->
                <div class="text-center mb-8">
                    <div class="floating flex items-center justify-center gap-3 mb-4">
                        <div class="w-20 h-20 bg-gradient-to-r from-ai-primary via-ai-accent to-ai-secondary rounded-full flex items-center justify-center shadow-lg pulse-glow">
                            <span class="material-symbols-outlined text-white text-3xl">smart_toy</span>
                        </div>
                    </div>
                    <h1 class="text-4xl lg:text-5xl font-black tracking-tight bg-gradient-to-r from-ai-primary to-ai-secondary bg-clip-text text-transparent mb-3">AcademiaBot</h1>
                    <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                        Your intelligent academic companion powered by AI
                    </p>
                    <div id="user-stats" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 max-w-md mx-auto">
                        <!-- Dynamic stats will be loaded here -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <button class="quick-action bounce-in p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-300 hover:scale-105 text-center" data-prompt="Analyze my academic performance and give me personalized recommendations">
                        <span class="material-symbols-outlined text-ai-primary text-2xl mb-2">analytics</span>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Performance Analysis</p>
                    </button>
                    <button class="quick-action bounce-in p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-300 hover:scale-105 text-center" data-prompt="Create a personalized study plan for my current courses">
                        <span class="material-symbols-outlined text-ai-secondary text-2xl mb-2">schedule</span>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Study Plan</p>
                    </button>
                    <button class="quick-action bounce-in p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-300 hover:scale-105 text-center" data-prompt="Help me calculate what grades I need to achieve my target CGPA">
                        <span class="material-symbols-outlined text-green-500 text-2xl mb-2">calculate</span>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Grade Calculator</p>
                    </button>
                    <button class="quick-action bounce-in p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-300 hover:scale-105 text-center" data-prompt="Give me strategies to improve my time management and productivity">
                        <span class="material-symbols-outlined text-ai-accent text-2xl mb-2">productivity</span>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Productivity Tips</p>
                    </button>
                </div>

                <!-- Chat Interface -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <!-- Chat Header -->
                    <div class="flex items-center gap-3 p-6 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-ai-primary/10 via-ai-accent/10 to-ai-secondary/10">
                        <div class="w-12 h-12 bg-gradient-to-r from-ai-primary to-ai-secondary rounded-full flex items-center justify-center shadow-md">
                            <span class="material-symbols-outlined text-white text-xl">school</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-900 dark:text-white text-lg">AcademiaBot</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400" id="bot-status">Analyzing your academic profile â€¢ Online</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="export-chat" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="Export conversation">
                                <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">download</span>
                            </button>
                            <button id="clear-chat" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="Clear conversation">
                                <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">delete</span>
                            </button>
                            <button id="suggest-questions" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="Suggest questions">
                                <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">lightbulb</span>
                            </button>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chat-messages" class="chat-container h-96 overflow-y-auto p-6 space-y-4 bg-gray-50/50 dark:bg-gray-900/50">
                        <!-- Welcome message will be loaded here -->
                    </div>

                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="hidden px-6 py-3 bg-gray-50/50 dark:bg-gray-900/50">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-ai-primary to-ai-secondary rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-white text-sm">school</span>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm border border-gray-200 dark:border-gray-700">
                                <div class="typing-indicator">
                                    <span>.</span>
                                    <span>.</span>
                                    <span>.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Interactive Actions -->
                    <div id="interactive-actions" class="hidden px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <div class="flex flex-wrap gap-2">
                            <!-- Action buttons will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <form id="chat-form" class="flex gap-3">
                            <div class="flex-1 relative">
                                <input 
                                    type="text" 
                                    id="message-input" 
                                    placeholder="Ask me anything about your academics..." 
                                    class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl px-4 py-3 pr-12 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-ai-primary focus:border-transparent transition-all duration-300"
                                    autocomplete="off"
                                >
                                <button type="button" id="voice-input" class="absolute right-3 top-1/2 transform -translate-y-1/2 p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                    <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">mic</span>
                                </button>
                            </div>
                            <button 
                                type="submit" 
                                id="send-button"
                                class="bg-gradient-to-r from-ai-primary to-ai-secondary text-white rounded-xl px-6 py-3 font-medium hover:opacity-90 transition-all duration-300 hover:scale-105 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <span class="material-symbols-outlined text-lg">send</span>
                                <span class="hidden sm:inline">Send</span>
                            </button>
                        </form>
                        
                        <!-- Suggested Questions -->
                        <div id="suggested-questions" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-3">
                            <!-- Dynamic suggestions based on user data -->
                        </div>
                    </div>
                </div>

                <!-- Features Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                    <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300">
                        <span class="material-symbols-outlined text-ai-primary text-3xl mb-3">psychology</span>
                        <h3 class="font-bold text-gray-900 dark:text-white mb-2">Smart Analysis</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Personalized insights based on your academic performance and goals</p>
                    </div>
                    <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300">
                        <span class="material-symbols-outlined text-ai-secondary text-3xl mb-3">auto_awesome</span>
                        <h3 class="font-bold text-gray-900 dark:text-white mb-2">AI Powered</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Advanced algorithms to optimize your study strategies and performance</p>
                    </div>
                    <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300">
                        <span class="material-symbols-outlined text-ai-accent text-3xl mb-3">trending_up</span>
                        <h3 class="font-bold text-gray-900 dark:text-white mb-2">Progress Tracking</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Monitor your academic growth and get improvement recommendations</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="w-full mt-16 border-t border-gray-200 dark:border-gray-700 pt-8 pb-12">
            <div class="container mx-auto px-4">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-4 text-gray-900 dark:text-white mb-4 sm:mb-0">
                        <div class="size-6 text-primary">
                            <svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip0_6_330)">
                                    <path clip-rule="evenodd" d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z" fill="currentColor" fill-rule="evenodd"></path>
                                </g>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">AcademiaTrack</h3>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-6 text-sm">
                        <div class="flex items-center gap-6 mb-4 sm:mb-0">
                            <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="homepage.html">Dashboard</a>
                            <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="progresspage.html">Progress</a>
                            <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="#.html">ChatBot</a>
                        </div>
                        <div class="flex items-center gap-6">
                            <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="activities-page.html">Activities</a>
                            <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="profile-page.html">Profile</a>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Â© 2025 AcademiaTrack. Your intelligent academic companion.</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Enhanced AcademiaBot with advanced features
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const chatForm = document.getElementById('chat-form');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const clearChatButton = document.getElementById('clear-chat');
        const suggestQuestionsButton = document.getElementById('suggest-questions');
        const exportChatButton = document.getElementById('export-chat');
        const interactiveActions = document.getElementById('interactive-actions');
        const userStats = document.getElementById('user-stats');
        const botStatus = document.getElementById('bot-status');
        const suggestedQuestions = document.getElementById('suggested-questions');

        let conversationHistory = [];
        let currentUser = null;
        let userAcademicData = {};

        // Load user data and initialize
        function initializeBot() {
            console.log("=== ACADEMIABOT INITIALIZATION ===");
            
            // Get current user data from localStorage
            const userDataString = localStorage.getItem('academiatrack_current_user');
            console.log("Raw user data from localStorage:", userDataString);
            
            currentUser = JSON.parse(userDataString || '{}');
            console.log("Parsed user data:", currentUser);
            
            loadUserAcademicData();
            loadConversationHistory();
            updateUserStats();
            updateSuggestedQuestions();
            showPersonalizedWelcome();
        }

        // Load user academic data - UPDATED to match progress page structure
        function loadUserAcademicData() {
            userAcademicData = {
                semesters: currentUser.semesters || [],
                activities: currentUser.activities || [],
                profile: {
                    name: currentUser.fullName,
                    level: currentUser.level,
                    department: currentUser.department,
                    university: currentUser.university
                }
            };
            
            console.log("Loaded academic data:", userAcademicData);
        }

        // Calculate user statistics - FIXED VERSION
        function calculateUserStats() {
            console.log("=== CALCULATING USER STATS ===");
            
            const semesters = userAcademicData.semesters || [];
            let totalCredits = 0;
            let totalGradePoints = 0;
            let totalCourses = 0;
            let completedCourses = 0;

            console.log("Found semesters:", semesters.length);

            semesters.forEach(semester => {
                console.log(`Processing semester: ${semester.level} Level - ${semester.type} ${semester.year}`);
                
                if (semester.courses && Array.isArray(semester.courses)) {
                    totalCourses += semester.courses.length;
                    console.log(`Found ${semester.courses.length} courses in this semester`);
                    
                    semester.courses.forEach(course => {
                        console.log(`Course: "${course.title}", Units: "${course.units}", Grade: "${course.grade}"`);
                        
                        if (course.units && course.grade && course.grade.trim() !== '') {
                            const credits = parseFloat(course.units);
                            const gradePoint = getGradePoint(course.grade);
                            
                            console.log(`Parsed - Credits: ${credits}, Grade Point: ${gradePoint}`);
                            
                            if (!isNaN(credits) && gradePoint !== null) {
                                totalGradePoints += credits * gradePoint;
                                totalCredits += credits;
                                completedCourses++;
                                console.log(`Added to calculation: ${credits} credits Ã— ${gradePoint} = ${credits * gradePoint} grade points`);
                            }
                        } else {
                            console.log(`Skipping course - missing units or grade`);
                        }
                    });
                } else {
                    console.log(`No courses array found in semester`);
                }
            });

            const cgpa = totalCredits > 0 ? (totalGradePoints / totalCredits).toFixed(2) : '0.00';
            
            console.log("=== FINAL CALCULATION RESULTS ===");
            console.log(`Total Credits: ${totalCredits}`);
            console.log(`Total Grade Points: ${totalGradePoints}`);
            console.log(`CGPA: ${cgpa}`);
            console.log(`Total Courses: ${totalCourses}`);
            console.log(`Completed Courses: ${completedCourses}`);
            console.log(`Total Semesters: ${semesters.length}`);

            return {
                cgpa,
                courses: totalCourses,
                completedCourses: completedCourses,
                semesters: semesters.length,
                credits: totalCredits
            };
        }

        // Get grade point from grade - UPDATED to match your progress page
        function getGradePoint(grade) {
            const gradePoints = {
                'A': 5.0,
                'B': 4.0, 
                'C': 3.0,
                'D': 2.0,
                'E': 1.0,
                'F': 0.0
            };
            const gradePoint = gradePoints[grade] !== undefined ? gradePoints[grade] : null;
            console.log(`Grade "${grade}" = ${gradePoint} points`);
            return gradePoint;
        }

        // Update user stats display - IMPROVED with better data
        function updateUserStats() {
            const stats = calculateUserStats();
            userStats.innerHTML = `
                <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="text-2xl font-bold text-ai-primary">${stats.cgpa}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">CGPA</div>
                </div>
                <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="text-2xl font-bold text-ai-secondary">${stats.courses}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">Total Courses</div>
                </div>
                <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="text-2xl font-bold text-ai-accent">${stats.semesters}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">Semesters</div>
                </div>
                <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="text-2xl font-bold text-green-500">${stats.credits}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">Credits</div>
                </div>
            `;
        }

        // Show personalized welcome message - IMPROVED with actual data
        function showPersonalizedWelcome() {
            const stats = calculateUserStats();
            const userName = userAcademicData.profile.name || 'there';
            const userLevel = userAcademicData.profile.level ? `${userAcademicData.profile.level} Level` : 'your current level';
            const userDepartment = userAcademicData.profile.department || 'your department';
            
            const welcomeMessage = `ðŸ‘‹ Hello ${userName}! I'm **AcademiaBot**, your AI academic assistant. 

I can see you're at **${userLevel}** studying **${userDepartment}** and I've analyzed your academic profile:

ðŸ“Š **Your Academic Summary:**
â€¢ **CGPA**: ${stats.cgpa}/5.0
â€¢ **Semesters**: ${stats.semesters}
â€¢ **Courses**: ${stats.courses} total, ${stats.completedCourses} with grades
â€¢ **Credits Completed**: ${stats.credits}

Here's what I can help you with:
â€¢ ðŸ“Š **Analyze** your academic performance in detail
â€¢ ðŸŽ¯ **Calculate** what grades you need for your target CGPA
â€¢ ðŸ“š **Create** personalized study plans for your courses
â€¢ â° **Manage** deadlines and optimize your schedule
â€¢ ðŸ’¡ **Provide** study strategies based on your performance
â€¢ ðŸŽ“ **Guide** your course selection and academic decisions

What would you like to work on today?`;

            addMessageToChat(welcomeMessage, 'bot');
            conversationHistory.push({
                text: welcomeMessage,
                sender: 'bot',
                timestamp: new Date()
            });
            saveConversationHistory();
        }

        // Update suggested questions based on user data
        function updateSuggestedQuestions() {
            const suggestions = getPersonalizedSuggestions();
            suggestedQuestions.innerHTML = suggestions.map(suggestion => `
                <button class="suggestion-btn text-xs bg-gradient-to-r from-ai-primary/10 to-ai-secondary/10 text-gray-700 dark:text-gray-300 rounded-lg px-3 py-2 hover:from-ai-primary/20 hover:to-ai-secondary/20 transition-all duration-300 border border-ai-primary/20 hover:border-ai-primary/40 text-left" data-question="${suggestion.question}">
                    ${suggestion.text}
                </button>
            `).join('');
        }

        // Get personalized suggestions based on user data
        function getPersonalizedSuggestions() {
            const stats = calculateUserStats();
            const level = userAcademicData.profile.level;
            const hasUpcomingDeadlines = checkUpcomingDeadlines().length > 0;

            const baseSuggestions = [
                { question: "How can I improve my CGPA?", text: "Improve my CGPA" },
                { question: "Create a study schedule for me", text: "Study schedule" },
                { question: "How do I manage multiple deadlines?", text: "Deadline management" }
            ];

            if (stats.cgpa < 3.0) {
                baseSuggestions.push({ 
                    question: "I need help improving my grades", 
                    text: "Grade improvement" 
                });
            }

            if (stats.cgpa >= 4.0) {
                baseSuggestions.push({ 
                    question: "How can I maintain my high GPA?", 
                    text: "Maintain excellence" 
                });
            }

            if (hasUpcomingDeadlines) {
                baseSuggestions.push({ 
                    question: "Help me prioritize my upcoming deadlines", 
                    text: "Priority tasks" 
                });
            }

            if (level === '100' || level === '200') {
                baseSuggestions.push({ 
                    question: "What courses should I take next semester?", 
                    text: "Course planning" 
                });
            }

            return baseSuggestions.slice(0, 4);
        }

        // Check for upcoming deadlines
        function checkUpcomingDeadlines() {
            const now = new Date();
            const activities = userAcademicData.activities || [];
            return activities.filter(activity => {
                if (!activity.dueDate || activity.completed) return false;
                const dueDate = new Date(activity.dueDate);
                return dueDate > now;
            }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        }

        // Enhanced AI Response Generator
        function generateAIResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            showTypingIndicator();

            // Update bot status based on query type
            if (lowerMessage.includes('gpa') || lowerMessage.includes('grade')) {
                botStatus.textContent = 'Calculating grades â€¢ Analyzing performance';
            } else if (lowerMessage.includes('study') || lowerMessage.includes('learn')) {
                botStatus.textContent = 'Creating study plan â€¢ Optimizing strategies';
            } else if (lowerMessage.includes('deadline') || lowerMessage.includes('due')) {
                botStatus.textContent = 'Checking deadlines â€¢ Planning schedule';
            } else {
                botStatus.textContent = 'Processing request â€¢ Generating insights';
            }

            return new Promise((resolve) => {
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateComprehensiveResponse(userMessage);
                    resolve(response);
                }, 1000 + Math.random() * 1000);
            });
        }

        // Comprehensive response generator
        function generateComprehensiveResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            const stats = calculateUserStats();
            const upcomingDeadlines = checkUpcomingDeadlines();

            if (lowerMessage.includes('gpa') || lowerMessage.includes('grade') || lowerMessage.includes('calculate')) {
                return generateGPAAnalysis(stats, userMessage);
            } else if (lowerMessage.includes('study') || lowerMessage.includes('exam') || lowerMessage.includes('learn')) {
                return generateStudyPlan(userMessage);
            } else if (lowerMessage.includes('deadline') || lowerMessage.includes('due') || lowerMessage.includes('assignment')) {
                return generateDeadlineAnalysis(upcomingDeadlines, userMessage);
            } else if (lowerMessage.includes('time') || lowerMessage.includes('schedule') || lowerMessage.includes('plan')) {
                return generateTimeManagementAdvice(userMessage);
            } else if (lowerMessage.includes('course') || lowerMessage.includes('subject')) {
                return generateCourseAdvice(userMessage);
            } else if (lowerMessage.includes('improve') || lowerMessage.includes('better')) {
                return generateImprovementStrategies(stats, userMessage);
            } else {
                return generateGeneralAcademicAdvice(userMessage);
            }
        }

        // Enhanced GPA analysis with detailed breakdown
        function generateGPAAnalysis(stats, userMessage) {
            const semesters = userAcademicData.semesters || [];
            
            let response = `ðŸ“Š **Detailed Academic Performance Analysis**\n\n`;
            response += `â€¢ **Current CGPA**: ${stats.cgpa}/5.0\n`;
            response += `â€¢ **Courses Completed**: ${stats.completedCourses} out of ${stats.courses}\n`;
            response += `â€¢ **Total Credits**: ${stats.credits}\n`;
            response += `â€¢ **Active Semesters**: ${stats.semesters}\n\n`;

            // Add semester breakdown
            if (semesters.length > 0) {
                response += `**Semester Breakdown**:\n`;
                semesters.forEach(semester => {
                    const semesterGPA = semester.gpa || calculateSemesterGPA(semester);
                    response += `â€¢ ${semester.level} Level - ${semester.type} ${semester.year}: GPA ${semesterGPA.toFixed(2)}\n`;
                });
                response += `\n`;
            }

            // Performance assessment
            if (stats.cgpa >= 4.5) {
                response += `ðŸŽ‰ **Outstanding Performance!** You're maintaining first-class honors.\n\n`;
                response += `**Recommendation**: Consider research opportunities, honors programs, or mentoring junior students.`;
            } else if (stats.cgpa >= 3.5) {
                response += `ðŸ‘ **Excellent Work!** You're on track for second class upper division.\n\n`;
                response += `**Recommendation**: Focus on maintaining consistency and explore leadership roles in academic clubs.`;
            } else if (stats.cgpa >= 2.5) {
                response += `ðŸ’ª **Good Foundation!** You're building a solid academic base.\n\n`;
                response += `**Recommendation**: Identify challenging courses and allocate more study time to them.`;
            } else {
                response += `ðŸ“š **Growth Opportunity!** Let's work on improving your performance.\n\n`;
                response += `**Recommendation**: Focus on foundational courses and utilize academic support services.`;
            }

            // Add interactive actions
            setTimeout(() => {
                showInteractiveActions([
                    { text: "Calculate target grades", action: "target_grades" },
                    { text: "See improvement plan", action: "improvement_plan" },
                    { text: "Semester comparison", action: "semester_comparison" }
                ]);
            }, 500);

            return response;
        }

        // Calculate GPA for a single semester
        function calculateSemesterGPA(semester) {
            let totalGradePoints = 0;
            let totalUnits = 0;

            if (semester.courses && Array.isArray(semester.courses)) {
                semester.courses.forEach(course => {
                    if (course.units && course.grade && course.grade.trim() !== '') {
                        const credits = parseFloat(course.units);
                        const gradePoint = getGradePoint(course.grade);
                        
                        if (!isNaN(credits) && gradePoint !== null) {
                            totalGradePoints += credits * gradePoint;
                            totalUnits += credits;
                        }
                    }
                });
            }

            return totalUnits > 0 ? totalGradePoints / totalUnits : 0;
        }

        // Enhanced study plan generator with actual courses
        function generateStudyPlan(userMessage) {
            const currentCourses = userAcademicData.semesters.flatMap(semester => 
                semester.courses?.filter(course => !course.grade || course.grade === '') || []
            );

            let response = `ðŸ“š **Personalized Study Strategy**\n\n`;

            if (currentCourses.length > 0) {
                response += `Based on your ${currentCourses.length} current courses:\n\n`;
                currentCourses.forEach((course, index) => {
                    response += `â€¢ **${course.title}** (${course.units} units) - `;
                    response += `Focus on ${getStudyFocus(course.title)}\n`;
                });
                response += `\n`;
            } else {
                response += `I don't see any current courses in progress. Make sure you've added courses to your current semester in the Progress page!\n\n`;
            }

            response += `**Effective Study Techniques**:\n`;
            response += `ðŸŽ¯ **Active Recall**: Test yourself regularly instead of passive reading\n`;
            response += `â° **Pomodoro Method**: 25min focus, 5min break cycles\n`;
            response += `ðŸ“– **Spaced Repetition**: Review material at increasing intervals\n`;
            response += `ðŸ‘¥ **Study Groups**: Collaborate to fill knowledge gaps\n`;
            response += `ðŸ”„ **Practice Problems**: Apply concepts actively, especially for technical courses\n`;

            setTimeout(() => {
                showInteractiveActions([
                    { text: "Create weekly schedule", action: "weekly_schedule" },
                    { text: "Set study goals", action: "study_goals" },
                    { text: "Exam preparation", action: "exam_prep" }
                ]);
            }, 500);

            return response;
        }

        // Get study focus based on course title
        function getStudyFocus(courseTitle) {
            const lowerTitle = courseTitle.toLowerCase();
            
            if (lowerTitle.includes('math') || lowerTitle.includes('calculus')) {
                return "practice problems and understanding theorems";
            } else if (lowerTitle.includes('programming') || lowerTitle.includes('computer')) {
                return "hands-on coding and debugging exercises";
            } else if (lowerTitle.includes('history') || lowerTitle.includes('literature')) {
                return "timelines, key events, and critical analysis";
            } else if (lowerTitle.includes('science') || lowerTitle.includes('biology') || lowerTitle.includes('chemistry')) {
                return "experiments, concepts, and real-world applications";
            } else if (lowerTitle.includes('language')) {
                return "vocabulary building and conversational practice";
            } else {
                return "key concepts and regular review";
            }
        }

        // Enhanced deadline analysis
        function generateDeadlineAnalysis(upcomingDeadlines, userMessage) {
            let response = `â° **Upcoming Deadlines Analysis**\n\n`;
            
            if (upcomingDeadlines.length === 0) {
                response += `ðŸŽ‰ **No upcoming deadlines found!** You're all caught up.\n\n`;
                response += `This is a great time to:\nâ€¢ Review completed work\nâ€¢ Get ahead on future assignments\nâ€¢ Focus on long-term projects`;
            } else {
                response += `You have **${upcomingDeadlines.length}** upcoming deadlines:\n\n`;
                
                upcomingDeadlines.slice(0, 5).forEach((activity, index) => {
                    const dueDate = new Date(activity.dueDate);
                    const daysLeft = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                    const priority = daysLeft <= 3 ? 'ðŸ”´ HIGH' : daysLeft <= 7 ? 'ðŸŸ¡ MEDIUM' : 'ðŸŸ¢ LOW';
                    
                    response += `${index + 1}. **${activity.title}**\n`;
                    response += `   ðŸ“… Due: ${dueDate.toLocaleDateString()} (${daysLeft} days)\n`;
                    response += `   âš¡ Priority: ${priority}\n`;
                    
                    if (activity.description) {
                        response += `   ðŸ“ ${activity.description.substring(0, 50)}${activity.description.length > 50 ? '...' : ''}\n`;
                    }
                    response += `\n`;
                });

                if (upcomingDeadlines.length > 5) {
                    response += `...and ${upcomingDeadlines.length - 5} more deadlines\n\n`;
                }

                response += `**Time Management Tips**:\n`;
                response += `â€¢ Break large tasks into smaller steps\n`;
                response += `â€¢ Start with highest priority items\n`;
                response += `â€¢ Allocate buffer time for unexpected delays\n`;
            }

            setTimeout(() => {
                showInteractiveActions([
                    { text: "Create deadline calendar", action: "deadline_calendar" },
                    { text: "Set reminders", action: "set_reminders" },
                    { text: "Breakdown tasks", action: "breakdown_tasks" }
                ]);
            }, 500);

            return response;
        }

        // Enhanced time management advice
        function generateTimeManagementAdvice(userMessage) {
            const stats = calculateUserStats();
            const currentCourses = userAcademicData.semesters.flatMap(semester => 
                semester.courses?.filter(course => !course.grade || course.grade === '') || []
            );

            let response = `â±ï¸ **Time Management Strategy**\n\n`;
            response += `Based on your ${currentCourses.length} current courses and ${stats.credits} credits:\n\n`;

            const weeklyStudyHours = stats.credits * 3; // Standard 3 hours per credit per week
            response += `**Recommended Weekly Study Time**: ${weeklyStudyHours} hours\n\n`;

            response += `**Optimal Schedule Breakdown**:\n`;
            response += `â€¢ ðŸŽ¯ **Deep Work**: ${Math.round(weeklyStudyHours * 0.6)} hours (focused study)\n`;
            response += `â€¢ ðŸ“š **Review**: ${Math.round(weeklyStudyHours * 0.25)} hours (revision)\n`;
            response += `â€¢ ðŸ’¡ **Practice**: ${Math.round(weeklyStudyHours * 0.15)} hours (applications)\n\n`;

            response += `**Productivity Techniques**:\n`;
            response += `ðŸ“… **Time Blocking**: Schedule specific study sessions\n`;
            response += `ðŸŽ¯ **Eisenhower Matrix**: Prioritize by urgency/importance\n`;
            response += `ðŸ”„ **Weekly Review**: Plan each week in advance\n`;
            response += `âš¡ **Energy Management**: Study during peak energy hours\n`;

            setTimeout(() => {
                showInteractiveActions([
                    { text: "Generate weekly plan", action: "weekly_plan" },
                    { text: "Set productivity goals", action: "productivity_goals" },
                    { text: "Track time usage", action: "time_tracking" }
                ]);
            }, 500);

            return response;
        }

        // Enhanced course advice
        function generateCourseAdvice(userMessage) {
            const currentSemester = userAcademicData.semesters[userAcademicData.semesters.length - 1];
            const currentCourses = currentSemester?.courses || [];
            const previousCourses = userAcademicData.semesters.flatMap((semester, index) => 
                userAcademicData.semesters.length - 1 !== index ? (semester.courses || []) : []
            );

            let response = `ðŸŽ“ **Course Selection & Strategy**\n\n`;

            if (currentCourses.length > 0) {
                response += `**Current Semester Courses**:\n`;
                currentCourses.forEach(course => {
                    const grade = course.grade ? `(Grade: ${course.grade})` : '(In Progress)';
                    response += `â€¢ ${course.title} ${course.units} units ${grade}\n`;
                });
                response += `\n`;
            }

            // Identify challenging courses based on previous grades
            const challengingCourses = previousCourses.filter(course => {
                const gradePoint = getGradePoint(course.grade);
                return gradePoint && gradePoint < 2.0; // Courses with grades below C
            });

            if (challengingCourses.length > 0) {
                response += `**Areas for Improvement**:\n`;
                challengingCourses.slice(0, 3).forEach(course => {
                    response += `â€¢ ${course.title} - Consider reviewing fundamentals\n`;
                });
                response += `\n`;
            }

            response += `**Course Selection Tips**:\n`;
            response += `â€¢ Balance workload across semesters\n`;
            response += `â€¢ Mix theoretical and practical courses\n`;
            response += `â€¢ Consider prerequisite requirements\n`;
            response += `â€¢ Align with career interests and goals\n`;

            setTimeout(() => {
                showInteractiveActions([
                    { text: "Plan next semester", action: "next_semester" },
                    { text: "Find related courses", action: "related_courses" },
                    { text: "Career alignment", action: "career_alignment" }
                ]);
            }, 500);

            return response;
        }

        // Enhanced improvement strategies
        function generateImprovementStrategies(stats, userMessage) {
            let response = `ðŸš€ **Academic Improvement Plan**\n\n`;

            if (stats.cgpa < 3.0) {
                response += `**Immediate Action Plan**:\n`;
                response += `ðŸŽ¯ **Diagnostic Assessment**: Identify specific weak areas\n`;
                response += `ðŸ“š **Foundation Building**: Review prerequisite concepts\n`;
                response += `â° **Study System**: Implement structured study routines\n`;
                response += `ðŸ‘¥ **Support Network**: Utilize office hours and study groups\n\n`;
            } else if (stats.cgpa < 4.0) {
                response += `**Optimization Strategies**:\n`;
                response += `ðŸŽ¯ **Advanced Techniques**: Implement active learning methods\n`;
                response += `ðŸ“Š **Performance Analytics**: Track study effectiveness\n`;
                response += `âš¡ **Efficiency Boost**: Optimize study environment and methods\n`;
                response += `ðŸŒŸ **Excellence Habits**: Develop consistent high-performance routines\n\n`;
            } else {
                response += `**Excellence Maintenance**:\n`;
                response += `ðŸŽ¯ **Advanced Applications**: Apply knowledge to real-world projects\n`;
                response += `ðŸ“š **Knowledge Expansion**: Explore advanced topics\n`;
                response += `ðŸ‘‘ **Leadership Development**: Mentor others and take leadership roles\n`;
                response += `ðŸ’¡ **Innovation Focus**: Work on research and creative projects\n\n`;
            }

            response += `**Key Improvement Areas**:\n`;
            response += `â€¢ Study technique refinement\n`;
            response += `â€¢ Time management optimization\n`;
            response += `â€¢ Learning environment enhancement\n`;
            response += `â€¢ Health and wellness balance\n`;

            setTimeout(() => {
                showInteractiveActions([
                    { text: "Create action plan", action: "action_plan" },
                    { text: "Set improvement goals", action: "improvement_goals" },
                    { text: "Track progress", action: "track_improvement" }
                ]);
            }, 500);

            return response;
        }

        // General academic advice fallback
        function generateGeneralAcademicAdvice(userMessage) {
            const tips = [
                "ðŸŽ¯ **Set Clear Goals**: Define specific, measurable academic targets for each semester",
                "ðŸ“š **Active Learning**: Engage with material through questioning and application",
                "â° **Consistent Routine**: Establish regular study habits rather than cramming",
                "ðŸ’¡ **Seek Understanding**: Focus on concepts rather than memorization",
                "ðŸ‘¥ **Collaborate**: Form study groups for different perspectives",
                "ðŸ”„ **Regular Review**: Schedule weekly reviews of all course material",
                "ðŸŽª **Balance**: Maintain physical activity and social connections",
                "ðŸ“Š **Self-Assessment**: Regularly evaluate your study methods and adjust",
                "ðŸ›Œ **Rest Well**: Prioritize sleep for memory consolidation and focus",
                "ðŸŽ **Healthy Habits**: Maintain nutrition and hydration for optimal brain function"
            ];

            const selectedTips = tips.sort(() => 0.5 - Math.random()).slice(0, 4);

            let response = `ðŸŽ“ **Academic Success Strategies**\n\n`;
            response += `Here are some proven strategies to enhance your academic performance:\n\n`;
            selectedTips.forEach(tip => {
                response += `${tip}\n\n`;
            });

            response += `Remember: Consistent, focused effort beats sporadic intensity every time!`;

            setTimeout(() => {
                showInteractiveActions([
                    { text: "More tips", action: "more_tips" },
                    { text: "Personalized advice", action: "personalized_advice" },
                    { text: "Success stories", action: "success_stories" }
                ]);
            }, 500);

            return response;
        }

        // Show interactive action buttons
        function showInteractiveActions(actions) {
            interactiveActions.innerHTML = '';
            interactiveActions.classList.remove('hidden');

            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = 'action-btn px-4 py-2 bg-gradient-to-r from-ai-primary/10 to-ai-secondary/10 text-ai-primary dark:text-ai-secondary rounded-lg text-sm font-medium hover:from-ai-primary/20 hover:to-ai-secondary/20 transition-all duration-300 border border-ai-primary/20 hover:border-ai-primary/40';
                button.textContent = action.text;
                button.dataset.action = action.action;
                interactiveActions.appendChild(button);
            });
        }

        // Handle interactive actions
        function handleInteractiveAction(action) {
            let response = '';

            switch (action) {
                case 'target_grades':
                    response = generateTargetGradesAnalysis();
                    break;
                case 'improvement_plan':
                    response = generateDetailedImprovementPlan();
                    break;
                case 'weekly_schedule':
                    response = generateWeeklySchedule();
                    break;
                case 'deadline_calendar':
                    response = generateDeadlineCalendar();
                    break;
                case 'action_plan':
                    response = generateDetailedActionPlan();
                    break;
                default:
                    response = `I'll help you with that! Could you provide more details about what you need?`;
            }

            addMessageToChat(response, 'bot');
            conversationHistory.push({
                text: response,
                sender: 'bot',
                timestamp: new Date()
            });
            saveConversationHistory();
        }

        // Generate target grades analysis
        function generateTargetGradesAnalysis() {
            const stats = calculateUserStats();
            const currentCourses = userAcademicData.semesters.flatMap(semester => 
                semester.courses?.filter(course => !course.grade || course.grade === '') || []
            );

            let response = `ðŸŽ¯ **Target Grade Calculator**\n\n`;
            response += `Current CGPA: ${stats.cgpa}/5.0\n\n`;

            const targetGPAs = [3.5, 4.0, 4.5];
            response += `**To achieve different target GPAs**:\n\n`;

            targetGPAs.forEach(target => {
                if (target > parseFloat(stats.cgpa)) {
                    const requiredAverage = calculateRequiredAverage(stats, target, currentCourses.length);
                    response += `â€¢ **${target} CGPA**: Need average of ${requiredAverage} in remaining courses\n`;
                }
            });

            response += `\n**Course-specific Targets**:\n`;
            currentCourses.forEach(course => {
                const recommendedGrade = getRecommendedGrade(course, stats.cgpa);
                response += `â€¢ ${course.title}: Aim for ${recommendedGrade} or higher\n`;
            });

            return response;
        }

        // Calculate required average grade
        function calculateRequiredAverage(currentStats, targetCGPA, numCourses) {
            if (numCourses === 0) return 'N/A';
            
            const currentTotalPoints = parseFloat(currentStats.cgpa) * currentStats.credits;
            const remainingCredits = numCourses * 3; // Assuming 3 units per course
            const totalNeededPoints = targetCGPA * (currentStats.credits + remainingCredits);
            const neededPoints = totalNeededPoints - currentTotalPoints;
            const requiredAverage = neededPoints / remainingCredits;

            return requiredAverage.toFixed(2);
        }

        // Get recommended grade for a course
        function getRecommendedGrade(course, currentCGPA) {
            const cgpa = parseFloat(currentCGPA);
            if (cgpa >= 4.5) return 'A';
            if (cgpa >= 4.0) return 'A';
            if (cgpa >= 3.5) return 'B+';
            if (cgpa >= 3.0) return 'B';
            return 'C+';
        }

        // Generate detailed improvement plan
        function generateDetailedImprovementPlan() {
            const stats = calculateUserStats();
            let response = `ðŸ“ˆ **Detailed Improvement Plan**\n\n`;
            
            response += `Based on your current CGPA of ${stats.cgpa}, here's a step-by-step plan:\n\n`;
            
            response += `**Week 1-2: Assessment Phase**\n`;
            response += `â€¢ Identify your weakest courses from previous semesters\n`;
            response += `â€¢ Analyze study habits and time management\n`;
            response += `â€¢ Set specific, measurable goals\n\n`;
            
            response += `**Week 3-8: Implementation Phase**\n`;
            response += `â€¢ Create a structured study schedule\n`;
            response += `â€¢ Focus on active learning techniques\n`;
            response += `â€¢ Seek help from professors and tutors\n\n`;
            
            response += `**Week 9-12: Optimization Phase**\n`;
            response += `â€¢ Review and adjust strategies\n`;
            response += `â€¢ Practice past exam questions\n`;
            response += `â€¢ Maintain consistency in study habits\n`;
            
            return response;
        }

        // Generate weekly schedule
        function generateWeeklySchedule() {
            const currentCourses = userAcademicData.semesters.flatMap(semester => 
                semester.courses?.filter(course => !course.grade || course.grade === '') || []
            );
            
            let response = `ðŸ“… **Recommended Weekly Study Schedule**\n\n`;
            
            if (currentCourses.length > 0) {
                response += `**Course Distribution**:\n`;
                currentCourses.forEach(course => {
                    const studyHours = Math.round(parseFloat(course.units || 3) * 3);
                    response += `â€¢ ${course.title}: ${studyHours} hours/week\n`;
                });
                response += `\n`;
            }
            
            response += `**Sample Schedule**:\n`;
            response += `Monday: 2-3 focused study sessions\n`;
            response += `Tuesday: Course-specific deep work\n`;
            response += `Wednesday: Review and practice problems\n`;
            response += `Thursday: Group study sessions\n`;
            response += `Friday: Catch-up and planning\n`;
            response += `Weekend: Major assignments and review\n`;
            
            return response;
        }

        // Enhanced message handling
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-fade-in flex gap-3 ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            
            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                sender === 'user' 
                    ? 'bg-gradient-to-r from-primary to-blue-600' 
                    : 'bg-gradient-to-r from-ai-primary to-ai-secondary'
            }`;
            
            avatar.innerHTML = sender === 'user' 
                ? '<span class="material-symbols-outlined text-white text-sm">person</span>'
                : '<span class="material-symbols-outlined text-white text-sm">school</span>';

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[80%] rounded-2xl px-4 py-3 shadow-sm border ${
                sender === 'user'
                    ? 'bg-primary text-white rounded-br-none'
                    : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 rounded-tl-none'
            }`;
            
            // Format message with basic markdown
            const formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            messageBubble.innerHTML = formattedText;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageBubble);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            typingIndicator.classList.remove('hidden');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        // Save conversation history
        function saveConversationHistory() {
            localStorage.setItem('academiabot_conversation', JSON.stringify(conversationHistory));
        }

        // Load conversation history
        function loadConversationHistory() {
            const saved = localStorage.getItem('academiabot_conversation');
            if (saved) {
                conversationHistory = JSON.parse(saved);
                // Display conversation history
                conversationHistory.forEach(msg => {
                    addMessageToChat(msg.text, msg.sender);
                });
            }
        }

        // Clear chat
        function clearChat() {
            chatMessages.innerHTML = '';
            conversationHistory = [];
            localStorage.removeItem('academiabot_conversation');
            showPersonalizedWelcome();
        }

        // Export chat
        function exportChat() {
            const chatText = conversationHistory.map(msg => 
                `${msg.sender === 'user' ? 'You' : 'AcademiaBot'}: ${msg.text}`
            ).join('\n\n');
            
            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `academiabot-conversation-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Event Listeners
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            
            if (!message) return;

            // Add user message
            addMessageToChat(message, 'user');
            conversationHistory.push({
                text: message,
                sender: 'user',
                timestamp: new Date()
            });

            // Clear input
            messageInput.value = '';
            sendButton.disabled = true;

            // Hide interactive actions during new conversation
            interactiveActions.classList.add('hidden');

            // Generate and add AI response
            try {
                const response = await generateAIResponse(message);
                addMessageToChat(response, 'bot');
                conversationHistory.push({
                    text: response,
                    sender: 'bot',
                    timestamp: new Date()
                });
                saveConversationHistory();
            } catch (error) {
                console.error('Error generating response:', error);
                addMessageToChat("I apologize, but I'm having trouble processing your request right now. Please try again.", 'bot');
            }
        });

        // Quick action buttons
        document.querySelectorAll('.quick-action').forEach(button => {
            button.addEventListener('click', () => {
                const prompt = button.dataset.prompt;
                messageInput.value = prompt;
                chatForm.dispatchEvent(new Event('submit'));
            });
        });

        // Suggested questions
        suggestedQuestions.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-btn')) {
                const question = e.target.dataset.question;
                messageInput.value = question;
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Interactive actions
        interactiveActions.addEventListener('click', (e) => {
            if (e.target.classList.contains('action-btn')) {
                const action = e.target.dataset.action;
                handleInteractiveAction(action);
                interactiveActions.classList.add('hidden');
            }
        });

        // Input validation
        messageInput.addEventListener('input', () => {
            sendButton.disabled = !messageInput.value.trim();
        });

        // Clear chat button
        clearChatButton.addEventListener('click', clearChat);

        // Export chat button
        exportChatButton.addEventListener('click', exportChat);

        // Suggest questions button
        suggestQuestionsButton.addEventListener('click', () => {
            updateSuggestedQuestions();
            // Add animation to suggestions
            suggestedQuestions.classList.add('bounce-in');
            setTimeout(() => suggestedQuestions.classList.remove('bounce-in'), 1000);
        });

        // Voice input (placeholder)
        document.getElementById('voice-input').addEventListener('click', () => {
            addMessageToChat("Voice input feature coming soon! Please type your message for now.", 'bot');
        });

        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', () => {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('-translate-x-full');
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('mobile-menu');
            const menuToggle = document.getElementById('menu-toggle');
            
            if (!menu.contains(e.target) && !menuToggle.contains(e.target) && !menu.classList.contains('-translate-x-full')) {
                menu.classList.add('-translate-x-full');
            }
        });

        // Initialize the bot when page loads
        document.addEventListener('DOMContentLoaded', initializeBot);

        // Add some sample data if no user data exists
        if (!localStorage.getItem('academiatrack_current_user')) {
            const sampleUser = {
                fullName: "Alex Johnson",
                level: "200",
                department: "Computer Science",
                university: "University of Technology",
                semesters: [
                    {
                        id: "semester-1",
                        level: "100",
                        type: "Harmattan",
                        year: "2023",
                        courses: [
                            { id: "course-1", title: "Introduction to Programming", units: "3", grade: "A" },
                            { id: "course-2", title: "Calculus I", units: "4", grade: "B" },
                            { id: "course-3", title: "Digital Logic", units: "3", grade: "A" }
                        ],
                        gpa: 4.25
                    },
                    {
                        id: "semester-2", 
                        level: "100",
                        type: "Rain",
                        year: "2023",
                        courses: [
                            { id: "course-4", title: "Data Structures", units: "3", grade: "B" },
                            { id: "course-5", title: "Discrete Mathematics", units: "3", grade: "A" },
                            { id: "course-6", title: "Computer Architecture", units: "3", grade: "C" }
                        ],
                        gpa: 3.67
                    },
                    {
                        id: "semester-3",
                        level: "200", 
                        type: "Harmattan",
                        year: "2024",
                        courses: [
                            { id: "course-7", title: "Algorithms", units: "3", grade: "" },
                            { id: "course-8", title: "Database Systems", units: "3", grade: "" },
                            { id: "course-9", title: "Operating Systems", units: "3", grade: "" }
                        ],
                        gpa: 0.00
                    }
                ],
                activities: [
                    { title: "Algorithms Assignment", dueDate: "2024-12-15", completed: false },
                    { title: "Database Project", dueDate: "2024-12-20", completed: false }
                ]
            };
            localStorage.setItem('academiatrack_current_user', JSON.stringify(sampleUser));
        }
    </script>
</body>
</html>